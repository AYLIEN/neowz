/*
 *  Project: neowz
 *  Description: news reader
 *  Author: parsaghaffari
 *  License: ?
 */
(function(e){function n(n,r){function l(){c();if(r.stories!==undefined&&r.stories.length>0&&T(r.stories)){v(r.stories,i,r)}else if(r.rss!==undefined&&r.rss!==""){m(r.rss,i,r)}else{e.error("Neowz: either stories or RSS link must be provided.")}k("onInit")}function c(){var t=e('<div id="neowz"></div>');s.append(t);s=s.find("#neowz");s.css({height:e(window).height(),width:e(window).width(),top:r.top,left:r.left,"z-index":r.zIndex});var n='<div id="neowz-header"><div id="neowz-ticker"><ul></ul></div><div class="close"><a href="#"><img src="img/close.png"></a></div></div><div id="neowz-frame-container"><iframe id="neowz-frame" sandbox="allow-forms allow-scripts allow-same-origin"></iframe></div><div id="neowz-next-container"><a href="#"><img src="img/next.png"></a></div><div id="neowz-previous-container"><a href="#"><img src="img/prev.png"></a></div><div id="neowz-loading"></div>';s.html(n);e("body").height(a);h();p();d()}function h(){s.find("#neowz-frame-container").height(e(window).height()-55)}function p(){s.find("#neowz-header #neowz-ticker").width(e(window).width()-52)}function d(){e(window).bind("resize",h);e(window).bind("resize",p);s.find("#neowz-header .close a").bind("click",C);s.find("#neowz-next-container a").bind("click",y);s.find("#neowz-previous-container a").bind("click",b);s.find("#neowz-frame").load(S);s.find("#neowz-frame").load(function(){e(this).scrollTo(0,0)});e(document).keyup(function(e){if(e.keyCode==27)C();if(e.keyCode==37)b();if(e.keyCode==39)y()})}function v(e,t,n){o=e;for(var r in o){x(o[r])}g()}function m(t,n,r){var i=[];jQuery.getFeed({url:"proxy.php?url="+t,success:function(t){window.feed=t;for(var s in t.items){var o=t.items[s].title;var u=e.url(t.items[s].id).attr("protocol")!==""?t.items[s].id:t.items[s].link;var a=t.items[s].updated;i.push({title:o,link:u,pubDate:a})}v(i,n,r)}})}function g(){if(u==undefined)u=0;if(u==0){s.find("#neowz-next-container").show();s.find("#neowz-previous-container").hide()}else if(u==o.length-1){s.find("#neowz-next-container").hide();s.find("#neowz-previous-container").show()}else{s.find("#neowz-next-container").show();s.find("#neowz-previous-container").show()}s.find("#neowz-ticker li").removeClass("current");e(s.find("#neowz-ticker li")[u]).addClass("current");s.find("#neowz-ticker").scrollTo("li:eq("+u+")",500,function(){try{s.find("#neowz-frame").attr("src",o[u].link);document.title=o[u].title}catch(e){console.log("Story does not have a link.")}});E();p();h()}function y(){if(u<o.length-1){u+=1;g()}return false}function b(){if(u>0){u-=1;g()}return false}function w(e){u=e;g();return false}function E(){var t=s.find("#neowz-loading");var n=e(window).height()/2-t.height()/2;var r=e(window).width()/2-t.width()/2;t.css({top:n,left:r,display:"block"})}function S(){s.find("#neowz-loading").css({display:"none"})}function x(t){var n=t.title.length>58?t.title.substr(0,56)+"...":t.title;n='<a href="#">'+n+"</a>";var r=e.url(t.link).attr("host").replace(/www\./g,"");var i="http://www.google.com/s2/u/0/favicons?domain="+r;console.log(t.pubDate);var o=(new Date(Date.parse(t.pubDate))).toISOString();var a="<li><h4>"+n+'</h4><h4><img src="'+i+'">'+r+'</h4><span class="timeago" title="'+o+'">'+o+"</span></li>";var f=e(a);s.find("#neowz-ticker ul").append(f);f.click(function(){if(u!==e(this).index())w(e(this).index())});f.find("span.timeago").timeago()}function T(e){return true}function N(e,t){if(t){r[e]=t}else{return r[e]}}function C(){s.each(function(){var n=this;var r=e(this);r.removeData("plugin_"+t);r.parent().removeData("plugin_"+t);r.removeAttr("style").children().remove();r.remove();e("body").height(f);k("onDestroy")})}function k(e){if(r[e]!==undefined){r[e].call(i)}}var i=n;var s=e(n);r=e.extend({},e.fn[t].defaults,r);var o=[];var u;var a=e(window).height();var f=e("body").height();l();return{option:N,destroy:C}}var t="neowz";e.fn[t]=function(r){if(typeof arguments[0]==="string"){var i=arguments[0];var s=Array.prototype.slice.call(arguments,1);var o;this.each(function(){if(e.data(this,"plugin_"+t)&&typeof e.data(this,"plugin_"+t)[i]==="function"){o=e.data(this,"plugin_"+t)[i].apply(this,s)}else{throw new Error("Method "+i+" does not exist on jQuery."+t)}});if(o!==undefined){return o}else{return this}}else if(typeof r==="object"||!r){return this.each(function(){if(!e.data(this,"plugin_"+t)){e.data(this,"plugin_"+t,new n(this,r))}})}};e.fn[t].defaults={width:"100%",height:"100%",top:0,left:0,zIndex:1e3}})(jQuery)